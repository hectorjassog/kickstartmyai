name: KickStartMyAI Template Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      run_full_validation:
        description: 'Run full validation (including functionality tests)'
        required: false
        default: true
        type: boolean

jobs:
  # Cross-platform basic validation (no services)
  validate-cross-platform:
    name: Basic Validation (${{ matrix.os }}, Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
        exclude:
          # Reduce matrix on PR to save resources
          - os: windows-latest
            python-version: '3.9'
          - os: macos-latest  
            python-version: '3.9'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', 'pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client
    
    - name: Install system dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install postgresql
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install cookiecutter
        pip install requests
        pip install -e .
    
    - name: Test basic template generation
      run: |
        # Create config file for basic test
        cat > cookiecutter_config.json << EOF
        {
          "project_name": "Test Project",
          "project_slug": "test_project_basic",
          "project_description": "A basic test project",
          "author_name": "Test Author",
          "author_email": "test@example.com",
          "version": "0.1.0",
          "include_docker": "n",
          "include_redis": "n",
          "database_type": "sqlite"
        }
        EOF
        
        # Generate project
        cookiecutter ./kickstartmyai/templates --config-file cookiecutter_config.json --no-input
        
        # Verify project was created
        ls -la test_project_basic/
        test -f test_project_basic/README.md
        test -f test_project_basic/requirements.txt
        test -f test_project_basic/app/main.py
    
    - name: Upload validation logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: validation-logs-${{ matrix.os }}-py${{ matrix.python-version }}
        path: |
          *.log
          test_project_basic/
        retention-days: 7

  # Linux-specific validation with services
  validate-linux-with-services:
    name: Linux Validation with Services (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.11', '3.12']
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:6
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client redis-tools
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install cookiecutter
        pip install requests
        pip install -e .
    
    - name: Test services connectivity
      run: |
        # Test PostgreSQL connection
        pg_isready -h localhost -p 5432
        PGPASSWORD=postgres psql -h localhost -p 5432 -U postgres -d test_db -c "SELECT version();"
        
        # Test Redis connection
        redis-cli -h localhost -p 6379 ping
    
    - name: Generate full-featured project
      run: |
        # Create config file for full test
        cat > cookiecutter_config.json << EOF
        {
          "project_name": "Full Test Project",
          "project_slug": "test_project_full",
          "project_description": "A full-featured test project",
          "author_name": "Test Author",
          "author_email": "test@example.com",
          "version": "0.1.0",
          "include_docker": "y",
          "include_redis": "y",
          "database_type": "postgresql"
        }
        EOF
        
        # Generate project
        cookiecutter ./kickstartmyai/templates --config-file cookiecutter_config.json --no-input
        
        # Verify project structure
        ls -la test_project_full/
        test -f test_project_full/docker-compose.yml
        test -f test_project_full/Dockerfile
    
    - name: Test generated project
      run: |
        cd test_project_full
        
        # Create virtual environment
        python -m venv .venv
        source .venv/bin/activate
        
        # Install dependencies
        pip install -r requirements.txt
        
        # Test basic functionality
        python -c "from app.main import app; print('FastAPI app imported successfully')"
    
    - name: Upload full project
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: full-project-py${{ matrix.python-version }}
        path: test_project_full/
        retention-days: 7

  test-generated-projects:
    name: Test Generated Projects
    runs-on: ubuntu-latest
    needs: validate-cross-platform
    
    strategy:
      matrix:
        config: [minimal, full]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install cookiecutter
        pip install -e .
    
    - name: Generate test project (${{ matrix.config }})
      run: |
        # Create config file
        cat > cookiecutter_config.json << EOF
        {
          "project_name": "Test Project ${{ matrix.config }}",
          "project_slug": "test_project_${{ matrix.config }}",
          "project_description": "A test project for validation",
          "author_name": "Test Author",
          "author_email": "test@example.com", 
          "version": "0.1.0",
          "include_docker": "${{ matrix.config == 'full' && 'y' || 'n' }}",
          "include_redis": "${{ matrix.config == 'full' && 'y' || 'n' }}",
          "database_type": "${{ matrix.config == 'full' && 'postgresql' || 'sqlite' }}"
        }
        EOF
        
        # Generate project
        cookiecutter ./kickstartmyai/templates --config-file cookiecutter_config.json --no-input
    
    - name: Test generated project structure
      run: |
        cd "test_project_${{ matrix.config }}"
        
        # Verify basic structure
        test -f README.md
        test -f requirements.txt
        test -f app/main.py
        test -f Makefile
        
        # Create virtual environment
        python -m venv .venv
        source .venv/bin/activate
        
        # Install dependencies
        pip install -r requirements.txt
        
        # Test basic import
        python -c "from app.main import app; print('App imported successfully')"

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
        pip install -e .
    
    - name: Run Bandit security scan
      run: |
        bandit -r kickstartmyai/ -f json -o bandit-report.json
      continue-on-error: true
    
    - name: Run Safety dependency scan
      run: |
        safety check --json --output safety-report.json
      continue-on-error: true
    
    - name: Upload security reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
        retention-days: 30

  validate-documentation:
    name: Validate Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install cookiecutter
        pip install -e .
    
    - name: Generate project for docs testing
      run: |
        cat > cookiecutter_config.json << EOF
        {
          "project_name": "Documentation Test Project",
          "project_slug": "docs_test_project",
          "project_description": "Testing documentation accuracy",
          "author_name": "Test Author",
          "author_email": "test@example.com",
          "version": "0.1.0",
          "include_docker": "y",
          "include_redis": "y",
          "database_type": "postgresql"
        }
        EOF
        
        cookiecutter ./kickstartmyai/templates --config-file cookiecutter_config.json --no-input
    
    - name: Validate README instructions
      run: |
        cd docs_test_project
        
        # Verify project was created correctly
        test -f README.md
        test -f requirements.txt
        test -f app/main.py
        
        # Test that all commands in README work
        python -m venv .venv
        source .venv/bin/activate
        
        # Follow README setup instructions
        pip install -r requirements.txt
        
        # Test basic functionality
        python -c "from app.main import app; print('Documentation test passed')"
    
    - name: Check documentation completeness
      run: |
        cd docs_test_project
        
        # Verify key files exist
        test -f README.md
        
        # Check for basic content
        grep -q "Installation" README.md || echo "Missing Installation section"
        grep -q "Usage" README.md || echo "Missing Usage section"

  publish-validation-report:
    name: Publish Validation Report
    runs-on: ubuntu-latest
    needs: [validate-cross-platform, validate-linux-with-services, test-generated-projects, security-scan, validate-documentation]
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Generate validation report
      run: |
        cat > validation-report.md << EOF
        # KickStartMyAI Validation Report
        
        **Date:** $(date -u)
        **Workflow:** ${{ github.workflow }}
        **Run ID:** ${{ github.run_id }}
        
        ## Summary
        
        - **Cross-Platform Validation:** ${{ needs.validate-cross-platform.result }}
        - **Linux with Services:** ${{ needs.validate-linux-with-services.result }}
        - **Generated Projects:** ${{ needs.test-generated-projects.result }}
        - **Security Scanning:** ${{ needs.security-scan.result }}
        - **Documentation:** ${{ needs.validate-documentation.result }}
        
        ## Details
        
        ### Cross-Platform Validation
        Status: ${{ needs.validate-cross-platform.result }}
        
        ### Linux with Services
        Status: ${{ needs.validate-linux-with-services.result }}
        
        ### Generated Projects Test
        Status: ${{ needs.test-generated-projects.result }}
        
        ### Security Scanning
        Status: ${{ needs.security-scan.result }}
        
        ### Documentation Validation
        Status: ${{ needs.validate-documentation.result }}
        
        ## Artifacts
        
        - Validation logs and reports are available as workflow artifacts
        - Security scan results available for 30 days
        - Test project outputs available for 7 days
        
        ---
        Generated by GitHub Actions
        EOF
    
    - name: Upload validation report
      uses: actions/upload-artifact@v4
      with:
        name: validation-report
        path: validation-report.md
        retention-days: 30
